<div class="min-h-screen flex">
    <!-- SIDEBAR -->
    <aside class="w-72 bg-zinc-950 border-r border-zinc-800 hidden md:flex flex-col">
        <div class="p-6 border-b border-zinc-800">
            <h1 class="text-2xl font-bold text-white mb-1">Galería Admin</h1>
            <p class="text-sm text-zinc-400">Panel de control</p>
        </div>

        <nav class="mt-6 px-4 flex-1">
            <ul class="space-y-1">
                <li>
                    <a href="#" data-link="dashboard"
                        class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-zinc-900">
                        <svg class="w-5 h-5 text-zinc-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M3 12h18M3 6h18M3 18h18" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                        <span>Dashboard</span>
                    </a>
                </li>

                <li>
                    <a href="#" data-link="gestion-cuadros"
                        class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-zinc-900">
                        <svg class="w-5 h-5 text-zinc-300" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M3 7h18v14H3zM21 3H3v4h18V3z" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                        <span>Cuadros</span>
                    </a>
                </li>

                <li>
                    <a href="#" data-link="gestion-categorias"
                        class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-zinc-900">
                        <svg class="w-5 h-5 text-zinc-300" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M12 2l3 7h7l-5.5 4 2 7L12 16 5.5 20l2-7L2 9h7z" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span>Categorías</span>
                    </a>
                </li>

                <%# Solo los administradores pueden ver la gestión de usuarios %>
                <% if (user && user.rol === 'admin') { %>
                <li>
                    <a href="#" data-link="usuarios"
                        class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-zinc-900">
                        <svg class="w-5 h-5 text-zinc-300" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M20 21v-2a4 4 0 0 0-3-3.87M4 21v-2a4 4 0 0 1 3-3.87" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                            <circle cx="12" cy="7" r="4" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                        <span>Usuarios</span>
                    </a>
                </li>
                <% } %>

                <li>
                    <a href="#" data-link="ajustes"
                        class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-zinc-900">
                        <svg class="w-5 h-5 text-zinc-300" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z" stroke-width="0.6" />
                        </svg>
                        <span>Ajustes</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="p-4 mt-auto border-t border-zinc-800">
            <form action="/logout" method="POST">
                <button type="submit" class="w-full px-3 py-2 bg-rose-600 text-white rounded-md hover:bg-rose-700 transition-colors">Cerrar sesión</button>
            </form>
        </div>
    </aside>

    <!-- MAIN -->
    <div class="flex-1 min-w-0">
        <!-- TOPBAR -->
        <header class="flex items-center justify-between px-6 py-4 border-b border-zinc-800 bg-zinc-900">
            <div class="flex items-center gap-4">
                <button id="mobileToggle" class="md:hidden p-2 bg-zinc-800 rounded-md" aria-label="Abrir menu">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M4 6h16M4 12h16M4 18h16" stroke-width="2" />
                    </svg>
                </button>
                <h2 class="text-xl font-semibold">Panel de administración</h2>
            </div>

            <div class="flex items-center gap-4">
                <div class="relative">
                    <input id="searchInput" type="text" placeholder="Buscar cuadros..."
                        class="bg-zinc-800 placeholder:text-zinc-500 rounded-md px-3 py-2 text-sm outline-none"
                        data-hook="admin-search">
                </div>

                <div class="flex items-center gap-3">
                    <div class="text-right">
                        <div class="text-xs text-zinc-400 capitalize"><%= user.rol %></div>
                        <div class="font-medium"><%= user.nombre %></div>
                    </div>
                    <img src="<%= user.avatar || '/images/default-avatar.png' %>" alt="Avatar de <%= user.nombre %>" class="w-10 h-10 rounded-full object-cover bg-zinc-700">
                </div>
            </div>
        </header>

        <!-- CONTENT -->
        <main class="p-6">

            <!-- DASHBOARD (id=dashboard) -->
            <%- include('partials/admin/dashboard') %>

            <!-- GESTIÓN DE CUADROS -->
            <%- include('partials/admin/cuadros-crud') %>

            <!-- GESTIÓN DE CATEGORÍAS -->
            <%- include('partials/admin/categorias-crud') %>

            <!-- USUARIOS (SOLO ADMIN) -->
            <% if (user && user.rol === 'admin') { %>
                <%- include('partials/admin/usuarios-crud') %>
            <% } %>

            <!-- AJUSTES -->
            <%- include('partials/admin/ajustes') %>

        </main>


    </div>
</div>


<!-- MODAL CUADROS (crear/editar) -->
<%- include('partials/admin/modales') %>

    <!-- Inyectar datos del usuario para el JS del cliente -->
    <script>
        window.currentUser = <%- JSON.stringify(user || null) %>;
    </script>

    <!-- ADMIN PANEL NAV JS -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const links = Array.from(document.querySelectorAll('[data-link]'));
            const sections = Array.from(document.querySelectorAll('main section[id]'));
            const SIDEBAR_ACTIVE_CLASS = 'bg-zinc-900';
            const SIDEBAR_ACTIVE_TEXT = 'text-white';

            // mobile sidebar toggle (simple)
            const mobileToggle = document.getElementById('mobileToggle');
            mobileToggle && mobileToggle.addEventListener('click', () => {
                const aside = document.querySelector('aside');
                if (!aside) return;
                aside.classList.toggle('hidden');
            });

            function showSection(id) {
                sections.forEach(s => {
                    if (s.id === id) {
                        s.classList.remove('hidden');
                    } else {
                        s.classList.add('hidden');
                    }
                });

                links.forEach(a => {
                    if (a.dataset.link === id) {
                        a.classList.add(SIDEBAR_ACTIVE_CLASS);
                        a.classList.add(SIDEBAR_ACTIVE_TEXT);
                        a.setAttribute('aria-current', 'true');
                    } else {
                        a.classList.remove(SIDEBAR_ACTIVE_CLASS);
                        a.classList.remove(SIDEBAR_ACTIVE_TEXT);
                        a.removeAttribute('aria-current');
                    }
                });

                // update hash for deep-linking / back button
                try {
                    history.replaceState(null, '', `#${id}`);
                } catch (e) {
                    location.hash = `#${id}`;
                }
            }

            // click listeners
            links.forEach(link => {
                link.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    const id = link.dataset.link;
                    if (!id) return;
                    showSection(id);
                });
            });

            // initial show (hash or dashboard)
            const initialHash = location.hash ? location.hash.replace('#', '') : null;
            const defaultSection = initialHash || (sections[0] && sections[0].id) || 'dashboard';
            showSection(defaultSection);

            // handle back/forward
            window.addEventListener('hashchange', () => {
                const h = location.hash.replace('#', '') || defaultSection;
                showSection(h);
            });

            // keyboard accessibility
            links.forEach(link => {
                link.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        link.click();
                    }
                });
            });

        });
    </script>