<%
  // Helper para construir URLs de filtro manteniendo los parámetros existentes
  const buildFilterURL = (newParams) => {
    const params = new URLSearchParams();
    if (search) params.set('search', search);

    // Si se hace clic en una categoría, se resetea la subcategoría
    if (newParams.categoria && !newParams.subcategoria) {
      params.set('categoria', newParams.categoria);
    } else {
      if (categoria) params.set('categoria', categoria);
      if (newParams.subcategoria) params.set('subcategoria', newParams.subcategoria);
    }
    return `/catalogo?${params.toString()}`;
  };
%>

<div class="mb-4">
  <label for="search-<%= isMobile ? 'mobile' : 'desktop' %>" class="block text-sm font-medium text-gray-300 mb-1">Buscar</label>
  <form action="/catalogo" method="GET" class="flex">
    <input type="hidden" name="categoria" value="<%= categoria || '' %>">
    <input type="hidden" name="subcategoria" value="<%= subcategoria || '' %>">
    <input
      type="text"
      id="search-<%= isMobile ? 'mobile' : 'desktop' %>"
      name="search"
      placeholder="Buscar cuadros..."
      class="w-full p-2 rounded-l-md bg-zinc-800 border border-zinc-700 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
      value="<%= search || '' %>"
    />
    <button type="submit" class="p-2 bg-emerald-600 rounded-r-md text-white hover:bg-emerald-700">Ir</button>
  </form>
</div>

<div class="space-y-2">
  <h4 class="font-medium text-gray-300">Categorías</h4>
  <div class="flex flex-wrap gap-2">
    <a href="/catalogo?<%= search ? 'search=' + search : '' %>" class="px-3 py-1 text-sm rounded-md transition-colors <%= !categoria ? 'bg-blue-600 text-white' : 'bg-zinc-800 hover:bg-zinc-700' %>">Todas</a>
    <% categoriasParaFiltro.forEach(cat => { %>
      <a href="<%= buildFilterURL({ categoria: cat.nombre }) %>"
         class="px-3 py-1 text-sm rounded-md transition-all duration-200 <%= categoria === cat.nombre ? 'ring-2 ring-offset-2 ring-offset-zinc-900 ring-white' : 'hover:opacity-80' %>"
         style="background-color: <%= cat.color || '#3f3f46' %>; color: #ffffff;">
        <%= cat.nombre %>
      </a>
    <% }); %>
  </div>
</div>

<% const categoriaSeleccionada = categoriasParaFiltro.find(c => c.nombre === categoria); %>
<% if (categoriaSeleccionada && categoriaSeleccionada.subcategorias.length > 0) { %>
  <div class="space-y-2 mt-4 pt-4 border-t border-zinc-800">
    <h4 class="font-medium text-gray-300">Subcategorías de <%= categoria %></h4>
    <div class="flex flex-wrap gap-2">
      <a href="<%= buildFilterURL({ categoria: categoria }) %>" class="px-3 py-1 text-sm rounded-md transition-colors <%= !subcategoria ? 'bg-blue-600 text-white' : 'bg-zinc-800 hover:bg-zinc-700' %>">Todas</a>
      <% categoriaSeleccionada.subcategorias.forEach(subcat => { %>
        <a href="<%= buildFilterURL({ subcategoria: subcat.nombre }) %>"
           class="px-3 py-1 text-sm rounded-md transition-colors <%= subcategoria === subcat.nombre ? 'bg-blue-600 text-white' : 'bg-zinc-800 hover:bg-zinc-700' %>">
          <%= subcat.nombre %>
        </a>
      <% }); %>
    </div>
  </div>
<% } %>